"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ParseGraphQLServer = void 0;

var _cors = _interopRequireDefault(require("cors"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var _graphqlUpload = require("graphql-upload");

var _expressApollo = require("apollo-server-express/dist/expressApollo");

var _graphqlPlaygroundHtml = require("@apollographql/graphql-playground-html");

var _graphql = require("graphql");

var _subscriptionsTransportWs = require("subscriptions-transport-ws");

var _middlewares = require("../middlewares");

var _requiredParameter = _interopRequireDefault(require("../requiredParameter"));

var _logger = _interopRequireDefault(require("../logger"));

var _ParseGraphQLSchema = require("./ParseGraphQLSchema");

var _ParseGraphQLController = _interopRequireWildcard(require("../Controllers/ParseGraphQLController"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ParseGraphQLServer {
  constructor(parseServer, config) {
    this.parseServer = parseServer || (0, _requiredParameter.default)('You must provide a parseServer instance!');

    if (!config || !config.graphQLPath) {
      (0, _requiredParameter.default)('You must provide a config.graphQLPath!');
    }

    this.config = config;
    this.parseGraphQLController = this.parseServer.config.parseGraphQLController;
    this.log = this.parseServer.config && this.parseServer.config.loggerController || _logger.default;
    this.parseGraphQLSchema = new _ParseGraphQLSchema.ParseGraphQLSchema({
      parseGraphQLController: this.parseGraphQLController,
      databaseController: this.parseServer.config.databaseController,
      log: this.log,
      graphQLCustomTypeDefs: this.config.graphQLCustomTypeDefs,
      appId: this.parseServer.config.appId,
      customLoad: this.config.customLoad
    });
  }

  async _getGraphQLOptions(req) {
    try {
      return {
        schema: await this.parseGraphQLSchema.load(),
        context: {
          info: req.info,
          config: req.config,
          auth: req.auth
        },
        formatError: error => {
          // Allow to console.log here to debug
          return error;
        }
      };
    } catch (e) {
      this.log.error(e.stack || typeof e.toString === 'function' && e.toString() || e);
      throw e;
    }
  }

  _transformMaxUploadSizeToBytes(maxUploadSize) {
    const unitMap = {
      kb: 1,
      mb: 2,
      gb: 3
    };
    return Number(maxUploadSize.slice(0, -2)) * Math.pow(1024, unitMap[maxUploadSize.slice(-2).toLowerCase()]);
  }

  applyGraphQL(app) {
    if (!app || !app.use) {
      (0, _requiredParameter.default)('You must provide an Express.js app instance!');
    }

    app.use(this.config.graphQLPath, (0, _graphqlUpload.graphqlUploadExpress)({
      maxFileSize: this._transformMaxUploadSizeToBytes(this.parseServer.config.maxUploadSize || '20mb')
    }));
    app.use(this.config.graphQLPath, (0, _cors.default)());
    app.use(this.config.graphQLPath, _bodyParser.default.json());
    app.use(this.config.graphQLPath, _middlewares.handleParseHeaders);
    app.use(this.config.graphQLPath, _middlewares.handleParseErrors);
    app.use(this.config.graphQLPath, (0, _expressApollo.graphqlExpress)(async req => await this._getGraphQLOptions(req)));
  }

  applyPlayground(app) {
    if (!app || !app.get) {
      (0, _requiredParameter.default)('You must provide an Express.js app instance!');
    }

    app.get(this.config.playgroundPath || (0, _requiredParameter.default)('You must provide a config.playgroundPath to applyPlayground!'), (_req, res) => {
      res.setHeader('Content-Type', 'text/html');
      res.write((0, _graphqlPlaygroundHtml.renderPlaygroundPage)({
        endpoint: this.config.graphQLPath,
        version: '1.7.25',
        subscriptionEndpoint: this.config.subscriptionsPath,
        headers: {
          'X-Parse-Application-Id': this.parseServer.config.appId,
          'X-Parse-Master-Key': this.parseServer.config.masterKey
        }
      }));
      res.end();
    });
  }

  createSubscriptions(server) {
    _subscriptionsTransportWs.SubscriptionServer.create({
      execute: _graphql.execute,
      subscribe: _graphql.subscribe,
      onOperation: async (_message, params, webSocket) => Object.assign({}, params, await this._getGraphQLOptions(webSocket.upgradeReq))
    }, {
      server,
      path: this.config.subscriptionsPath || (0, _requiredParameter.default)('You must provide a config.subscriptionsPath to createSubscriptions!')
    });
  }

  setGraphQLConfig(graphQLConfig) {
    return this.parseGraphQLController.updateGraphQLConfig(graphQLConfig);
  }

}

exports.ParseGraphQLServer = ParseGraphQLServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9HcmFwaFFML1BhcnNlR3JhcGhRTFNlcnZlci5qcyJdLCJuYW1lcyI6WyJQYXJzZUdyYXBoUUxTZXJ2ZXIiLCJjb25zdHJ1Y3RvciIsInBhcnNlU2VydmVyIiwiY29uZmlnIiwiZ3JhcGhRTFBhdGgiLCJwYXJzZUdyYXBoUUxDb250cm9sbGVyIiwibG9nIiwibG9nZ2VyQ29udHJvbGxlciIsImRlZmF1bHRMb2dnZXIiLCJwYXJzZUdyYXBoUUxTY2hlbWEiLCJQYXJzZUdyYXBoUUxTY2hlbWEiLCJkYXRhYmFzZUNvbnRyb2xsZXIiLCJncmFwaFFMQ3VzdG9tVHlwZURlZnMiLCJhcHBJZCIsImN1c3RvbUxvYWQiLCJfZ2V0R3JhcGhRTE9wdGlvbnMiLCJyZXEiLCJzY2hlbWEiLCJsb2FkIiwiY29udGV4dCIsImluZm8iLCJhdXRoIiwiZm9ybWF0RXJyb3IiLCJlcnJvciIsImUiLCJzdGFjayIsInRvU3RyaW5nIiwiX3RyYW5zZm9ybU1heFVwbG9hZFNpemVUb0J5dGVzIiwibWF4VXBsb2FkU2l6ZSIsInVuaXRNYXAiLCJrYiIsIm1iIiwiZ2IiLCJOdW1iZXIiLCJzbGljZSIsIk1hdGgiLCJwb3ciLCJ0b0xvd2VyQ2FzZSIsImFwcGx5R3JhcGhRTCIsImFwcCIsInVzZSIsIm1heEZpbGVTaXplIiwiYm9keVBhcnNlciIsImpzb24iLCJoYW5kbGVQYXJzZUhlYWRlcnMiLCJoYW5kbGVQYXJzZUVycm9ycyIsImFwcGx5UGxheWdyb3VuZCIsImdldCIsInBsYXlncm91bmRQYXRoIiwiX3JlcSIsInJlcyIsInNldEhlYWRlciIsIndyaXRlIiwiZW5kcG9pbnQiLCJ2ZXJzaW9uIiwic3Vic2NyaXB0aW9uRW5kcG9pbnQiLCJzdWJzY3JpcHRpb25zUGF0aCIsImhlYWRlcnMiLCJtYXN0ZXJLZXkiLCJlbmQiLCJjcmVhdGVTdWJzY3JpcHRpb25zIiwic2VydmVyIiwiU3Vic2NyaXB0aW9uU2VydmVyIiwiY3JlYXRlIiwiZXhlY3V0ZSIsInN1YnNjcmliZSIsIm9uT3BlcmF0aW9uIiwiX21lc3NhZ2UiLCJwYXJhbXMiLCJ3ZWJTb2NrZXQiLCJPYmplY3QiLCJhc3NpZ24iLCJ1cGdyYWRlUmVxIiwicGF0aCIsInNldEdyYXBoUUxDb25maWciLCJncmFwaFFMQ29uZmlnIiwidXBkYXRlR3JhcGhRTENvbmZpZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztBQUVBLE1BQU1BLGtCQUFOLENBQXlCO0FBR3ZCQyxFQUFBQSxXQUFXLENBQUNDLFdBQUQsRUFBY0MsTUFBZCxFQUFzQjtBQUMvQixTQUFLRCxXQUFMLEdBQW1CQSxXQUFXLElBQUksZ0NBQWtCLDBDQUFsQixDQUFsQzs7QUFDQSxRQUFJLENBQUNDLE1BQUQsSUFBVyxDQUFDQSxNQUFNLENBQUNDLFdBQXZCLEVBQW9DO0FBQ2xDLHNDQUFrQix3Q0FBbEI7QUFDRDs7QUFDRCxTQUFLRCxNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLRSxzQkFBTCxHQUE4QixLQUFLSCxXQUFMLENBQWlCQyxNQUFqQixDQUF3QkUsc0JBQXREO0FBQ0EsU0FBS0MsR0FBTCxHQUNHLEtBQUtKLFdBQUwsQ0FBaUJDLE1BQWpCLElBQTJCLEtBQUtELFdBQUwsQ0FBaUJDLE1BQWpCLENBQXdCSSxnQkFBcEQsSUFBeUVDLGVBRDNFO0FBRUEsU0FBS0Msa0JBQUwsR0FBMEIsSUFBSUMsc0NBQUosQ0FBdUI7QUFDL0NMLE1BQUFBLHNCQUFzQixFQUFFLEtBQUtBLHNCQURrQjtBQUUvQ00sTUFBQUEsa0JBQWtCLEVBQUUsS0FBS1QsV0FBTCxDQUFpQkMsTUFBakIsQ0FBd0JRLGtCQUZHO0FBRy9DTCxNQUFBQSxHQUFHLEVBQUUsS0FBS0EsR0FIcUM7QUFJL0NNLE1BQUFBLHFCQUFxQixFQUFFLEtBQUtULE1BQUwsQ0FBWVMscUJBSlk7QUFLL0NDLE1BQUFBLEtBQUssRUFBRSxLQUFLWCxXQUFMLENBQWlC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QUFnQixDQUFDQyxhQUFELEVBQTZDO0FBQzNELFdBQU8sS0FBS3RFLHNCQUFMLENBQTRCdUUsbUJBQTVCLENBQWdERCxhQUFoRCxDQUFQO0FBQ0Q7O0FBMUhzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjb3JzTWlkZGxld2FyZSBmcm9tICdjb3JzJztcbmltcG9ydCBib2R5UGFyc2VyIGZyb20gJ2JvZHktcGFyc2VyJztcbmltcG9ydCB7IGdyYXBocWxVcGxvYWRFeHByZXNzIH0gZnJvbSAnZ3JhcGhxbC11cGxvYWQnO1xuaW1wb3J0IHsgZ3JhcGhxbEV4cHJlc3MgfSBmcm9tICdhcG9sbG8tc2VydmVyLWV4cHJlc3MvZGlzdC9leHByZXNzQXBvbGxvJztcbmltcG9ydCB7IHJlbmRlclBsYXlncm91bmRQYWdlIH0gZnJvbSAnQGFwb2xsb2dyYXBocWwvZ3JhcGhxbC1wbGF5Z3JvdW5kLWh0bWwnO1xuaW1wb3J0IHsgZXhlY3V0ZSwgc3Vic2NyaWJlIH0gZnJvbSAnZ3JhcGhxbCc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb25TZXJ2ZXIgfSBmcm9tICdzdWJzY3JpcHRpb25zLXRyYW5zcG9ydC13cyc7XG5pbXBvcnQgeyBoYW5kbGVQYXJzZUVycm9ycywgaGFuZGxlUGFyc2VIZWFkZXJzIH0gZnJvbSAnLi4vbWlkZGxld2FyZXMnO1xuaW1wb3J0IHJlcXVpcmVkUGFyYW1ldGVyIGZyb20gJy4uL3JlcXVpcmVkUGFyYW1ldGVyJztcbmltcG9ydCBkZWZhdWx0TG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBQYXJzZUdyYXBoUUxTY2hlbWEgfSBmcm9tICcuL1BhcnNlR3JhcGhRTFNjaGVtYSc7XG5pbXBvcnQgUGFyc2VHcmFwaFFMQ29udHJvbGxlciwgeyBQYXJzZUdyYXBoUUxDb25maWcgfSBmcm9tICcuLi9Db250cm9sbGVycy9QYXJzZUdyYXBoUUxDb250cm9sbGVyJztcblxuY2xhc3MgUGFyc2VHcmFwaFFMU2VydmVyIHtcbiAgcGFyc2VHcmFwaFFMQ29udHJvbGxlcjogUGFyc2VHcmFwaFFMQ29udHJvbGxlcjtcblxuICBjb25zdHJ1Y3RvcihwYXJzZVNlcnZlciwgY29uZmlnKSB7XG4gICAgdGhpcy5wYXJzZVNlcnZlciA9IHBhcnNlU2VydmVyIHx8IHJlcXVpcmVkUGFyYW1ldGVyKCdZb3UgbXVzdCBwcm92aWRlIGEgcGFyc2VTZXJ2ZXIgaW5zdGFuY2UhJyk7XG4gICAgaWYgKCFjb25maWcgfHwgIWNvbmZpZy5ncmFwaFFMUGF0aCkge1xuICAgICAgcmVxdWlyZWRQYXJhbWV0ZXIoJ1lvdSBtdXN0IHByb3ZpZGUgYSBjb25maWcuZ3JhcGhRTFBhdGghJyk7XG4gICAgfVxuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMucGFyc2VHcmFwaFFMQ29udHJvbGxlciA9IHRoaXMucGFyc2VTZXJ2ZXIuY29uZmlnLnBhcnNlR3JhcGhRTENvbnRyb2xsZXI7XG4gICAgdGhpcy5sb2cgPVxuICAgICAgKHRoaXMucGFyc2VTZXJ2ZXIuY29uZmlnICYmIHRoaXMucGFyc2VTZXJ2ZXIuY29uZmlnLmxvZ2dlckNvbnRyb2xsZXIpIHx8IGRlZmF1bHRMb2dnZXI7XG4gICAgdGhpcy5wYXJzZUdyYXBoUUxTY2hlbWEgPSBuZXcgUGFyc2VHcmFwaFFMU2NoZW1hKHtcbiAgICAgIHBhcnNlR3JhcGhRTENvbnRyb2xsZXI6IHRoaXMucGFyc2VHcmFwaFFMQ29udHJvbGxlcixcbiAgICAgIGRhdGFiYXNlQ29udHJvbGxlcjogdGhpcy5wYXJzZVNlcnZlci5jb25maWcuZGF0YWJhc2VDb250cm9sbGVyLFxuICAgICAgbG9nOiB0aGlzLmxvZyxcbiAgICAgIGdyYXBoUUxDdXN0b21UeXBlRGVmczogdGhpcy5jb25maWcuZ3JhcGhRTEN1c3RvbVR5cGVEZWZzLFxuICAgICAgYXBwSWQ6IHRoaXMucGFyc2VTZXJ2ZXIuY29uZmlnLmFwcElkLFxuICAgICAgY3VzdG9tTG9hZDogdGhpcy5jb25maWcuY3VzdG9tTG9hZFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgX2dldEdyYXBoUUxPcHRpb25zKHJlcSkge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzY2hlbWE6IGF3YWl0IHRoaXMucGFyc2VHcmFwaFFMU2NoZW1hLmxvYWQoKSxcbiAgICAgICAgY29udGV4dDoge1xuICAgICAgICAgIGluZm86IHJlcS5pbmZvLFxuICAgICAgICAgIGNvbmZpZzogcmVxLmNvbmZpZyxcbiAgICAgICAgICBhdXRoOiByZXEuYXV0aCxcbiAgICAgICAgfSxcbiAgICAgICAgZm9ybWF0RXJyb3I6IGVycm9yID0+IHtcbiAgICAgICAgICAvLyBBbGxvdyB0byBjb25zb2xlLmxvZyBoZXJlIHRvIGRlYnVnXG4gICAgICAgICAgcmV0dXJuIGVycm9yO1xuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aGlzLmxvZy5lcnJvcihlLnN0YWNrIHx8ICh0eXBlb2YgZS50b1N0cmluZyA9PT0gJ2Z1bmN0aW9uJyAmJiBlLnRvU3RyaW5nKCkpIHx8IGUpO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cblxuICBfdHJhbnNmb3JtTWF4VXBsb2FkU2l6ZVRvQnl0ZXMobWF4VXBsb2FkU2l6ZSkge1xuICAgIGNvbnN0IHVuaXRNYXAgPSB7XG4gICAgICBrYjogMSxcbiAgICAgIG1iOiAyLFxuICAgICAgZ2I6IDMsXG4gICAgfTtcblxuICAgIHJldHVybiAoXG4gICAgICBOdW1iZXIobWF4VXBsb2FkU2l6ZS5zbGljZSgwLCAtMikpICpcbiAgICAgIE1hdGgucG93KDEwMjQsIHVuaXRNYXBbbWF4VXBsb2FkU2l6ZS5zbGljZSgtMikudG9Mb3dlckNhc2UoKV0pXG4gICAgKTtcbiAgfVxuXG4gIGFwcGx5R3JhcGhRTChhcHApIHtcbiAgICBpZiAoIWFwcCB8fCAhYXBwLnVzZSkge1xuICAgICAgcmVxdWlyZWRQYXJhbWV0ZXIoJ1lvdSBtdXN0IHByb3ZpZGUgYW4gRXhwcmVzcy5qcyBhcHAgaW5zdGFuY2UhJyk7XG4gICAgfVxuXG4gICAgYXBwLnVzZShcbiAgICAgIHRoaXMuY29uZmlnLmdyYXBoUUxQYXRoLFxuICAgICAgZ3JhcGhxbFVwbG9hZEV4cHJlc3Moe1xuICAgICAgICBtYXhGaWxlU2l6ZTogdGhpcy5fdHJhbnNmb3JtTWF4VXBsb2FkU2l6ZVRvQnl0ZXMoXG4gICAgICAgICAgdGhpcy5wYXJzZVNlcnZlci5jb25maWcubWF4VXBsb2FkU2l6ZSB8fCAnMjBtYidcbiAgICAgICAgKSxcbiAgICAgIH0pXG4gICAgKTtcbiAgICBhcHAudXNlKHRoaXMuY29uZmlnLmdyYXBoUUxQYXRoLCBjb3JzTWlkZGxld2FyZSgpKTtcbiAgICBhcHAudXNlKHRoaXMuY29uZmlnLmdyYXBoUUxQYXRoLCBib2R5UGFyc2VyLmpzb24oKSk7XG4gICAgYXBwLnVzZSh0aGlzLmNvbmZpZy5ncmFwaFFMUGF0aCwgaGFuZGxlUGFyc2VIZWFkZXJzKTtcbiAgICBhcHAudXNlKHRoaXMuY29uZmlnLmdyYXBoUUxQYXRoLCBoYW5kbGVQYXJzZUVycm9ycyk7XG4gICAgYXBwLnVzZShcbiAgICAgIHRoaXMuY29uZmlnLmdyYXBoUUxQYXRoLFxuICAgICAgZ3JhcGhxbEV4cHJlc3MoYXN5bmMgcmVxID0+IGF3YWl0IHRoaXMuX2dldEdyYXBoUUxPcHRpb25zKHJlcSkpXG4gICAgKTtcbiAgfVxuXG4gIGFwcGx5UGxheWdyb3VuZChhcHApIHtcbiAgICBpZiAoIWFwcCB8fCAhYXBwLmdldCkge1xuICAgICAgcmVxdWlyZWRQYXJhbWV0ZXIoJ1lvdSBtdXN0IHByb3ZpZGUgYW4gRXhwcmVzcy5qcyBhcHAgaW5zdGFuY2UhJyk7XG4gICAgfVxuICAgIGFwcC5nZXQoXG4gICAgICB0aGlzLmNvbmZpZy5wbGF5Z3JvdW5kUGF0aCB8fFxuICAgICAgICByZXF1aXJlZFBhcmFtZXRlcignWW91IG11c3QgcHJvdmlkZSBhIGNvbmZpZy5wbGF5Z3JvdW5kUGF0aCB0byBhcHBseVBsYXlncm91bmQhJyksXG4gICAgICAoX3JlcSwgcmVzKSA9PiB7XG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsICd0ZXh0L2h0bWwnKTtcbiAgICAgICAgcmVzLndyaXRlKFxuICAgICAgICAgIHJlbmRlclBsYXlncm91bmRQYWdlKHtcbiAgICAgICAgICAgIGVuZHBvaW50OiB0aGlzLmNvbmZpZy5ncmFwaFFMUGF0aCxcbiAgICAgICAgICAgIHZlcnNpb246ICcxLjcuMjUnLFxuICAgICAgICAgICAgc3Vic2NyaXB0aW9uRW5kcG9pbnQ6IHRoaXMuY29uZmlnLnN1YnNjcmlwdGlvbnNQYXRoLFxuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAnWC1QYXJzZS1BcHBsaWNhdGlvbi1JZCc6IHRoaXMucGFyc2VTZXJ2ZXIuY29uZmlnLmFwcElkLFxuICAgICAgICAgICAgICAnWC1QYXJzZS1NYXN0ZXItS2V5JzogdGhpcy5wYXJzZVNlcnZlci5jb25maWcubWFzdGVyS2V5LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgICByZXMuZW5kKCk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGNyZWF0ZVN1YnNjcmlwdGlvbnMoc2VydmVyKSB7XG4gICAgU3Vic2NyaXB0aW9uU2VydmVyLmNyZWF0ZShcbiAgICAgIHtcbiAgICAgICAgZXhlY3V0ZSxcbiAgICAgICAgc3Vic2NyaWJlLFxuICAgICAgICBvbk9wZXJhdGlvbjogYXN5bmMgKF9tZXNzYWdlLCBwYXJhbXMsIHdlYlNvY2tldCkgPT5cbiAgICAgICAgICBPYmplY3QuYXNzaWduKHt9LCBwYXJhbXMsIGF3YWl0IHRoaXMuX2dldEdyYXBoUUxPcHRpb25zKHdlYlNvY2tldC51cGdyYWRlUmVxKSksXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBzZXJ2ZXIsXG4gICAgICAgIHBhdGg6XG4gICAgICAgICAgdGhpcy5jb25maWcuc3Vic2NyaXB0aW9uc1BhdGggfHxcbiAgICAgICAgICByZXF1aXJlZFBhcmFtZXRlcignWW91IG11c3QgcHJvdmlkZSBhIGNvbmZpZy5zdWJzY3JpcHRpb25zUGF0aCB0byBjcmVhdGVTdWJzY3JpcHRpb25zIScpLFxuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBzZXRHcmFwaFFMQ29uZmlnKGdyYXBoUUxDb25maWc6IFBhcnNlR3JhcGhRTENvbmZpZyk6IFByb21pc2Uge1xuICAgIHJldHVybiB0aGlzLnBhcnNlR3JhcGhRTENvbnRyb2xsZXIudXBkYXRlR3JhcGhRTENvbmZpZyhncmFwaFFMQ29uZmlnKTtcbiAgfVxufVxuXG5leHBvcnQgeyBQYXJzZUdyYXBoUUxTZXJ2ZXIgfTtcbiJdfQ==